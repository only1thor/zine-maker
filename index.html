<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zine Arranger! For PDFs</title>
    <link rel="stylesheet" href="./vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./styles.css">
    <script src="./pdfjs/build/pdf.js"></script>
</head>

<body>
    <!-- Header Section -->
    <div class="header-section noprint">
        <div class="container">
            <div class="text-center">
                <h1>üìñ Zine Arranger</h1>
                <p class="lead">Transform your PDF into a printable zine in three easy steps</p>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="container py-4 noprint">
            
            <!-- Step 1: Upload PDF -->
            <div class="card step-card mb-4" id="step1-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <span class="step-number">1</span>
                        <h3 class="mb-0">Upload Your PDF</h3>
                    </div>
                    <p class="text-muted mb-3">Choose a PDF file to convert into a zine format</p>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="selector" accept=".pdf" class="form-control">
                        <label for="selector" class="file-input-label" id="file-label">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span id="file-label-text">
                                <strong>Click to select a PDF file</strong><br>
                                <small class="text-muted">or drag and drop here</small>
                            </span>
                        </label>
                    </div>
                    
                    <div id="file-info" class="mt-3" style="display: none;">
                        <div class="alert alert-success d-flex align-items-center">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <div>
                                <strong>File loaded:</strong> <span id="file-name"></span><br>
                                <small><span id="page-count"></span> pages</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Configure Settings -->
            <div class="settings-section" id="step2-section">
                <div class="card step-card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="step-number">2</span>
                            <h3 class="mb-0">Configure Zine Settings</h3>
                        </div>
                        <p class="text-muted mb-4">Customize your zine layout and format</p>
                        
                        <div id="page-count-warning" class="alert alert-custom mb-4" style="display: none;">
                            <strong>‚ÑπÔ∏è Page Count Notice:</strong> <span id="lbl-pc-mult"></span>
                        </div>

                        <div class="row">
                            <!-- Zine Size -->
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3">Zine Size</h5>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" id="zs-mini" name="zsize" onchange="selectEighthSize()">
                                    <label class="form-check-label" for="zs-mini">
                                        <strong>Eighth Size</strong> (Mini-zine)
                                        <br><small class="text-muted">8 pages per sheet, compact format</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" id="zs-qtr" name="zsize" checked onchange="selectQuarterSize()">
                                    <label class="form-check-label" for="zs-qtr">
                                        <strong>Quarter Size</strong>
                                        <br><small class="text-muted">4 pages per sheet, medium format</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="zs-half" name="zsize" onchange="selectHalfSize()">
                                    <label class="form-check-label" for="zs-half">
                                        <strong>Half Size</strong>
                                        <br><small class="text-muted">2 pages per sheet, large format</small>
                                    </label>
                                </div>
                            </div>

                            <!-- Basic Options -->
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3">Printing Options</h5>
                                <div class="mb-3">
                                    <label class="form-label"><strong>Print on:</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="dx-single" name="duplex" checked onchange="refreshSpecs()">
                                        <label class="form-check-label" for="dx-single">One Side</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="dx-double" name="duplex" onchange="refreshSpecs()">
                                        <label class="form-check-label" for="dx-double">Both Sides (Duplex)</label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Zine Orientation:</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="ori-portrait" name="paper-orient" checked onchange="refreshSpecs()">
                                        <label class="form-check-label" for="ori-portrait">Portrait</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="ori-landscape" name="paper-orient" onchange="refreshSpecs()">
                                        <label class="form-check-label" for="ori-landscape">Landscape</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Options (Collapsible) -->
                        <div class="accordion" id="advancedAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                        <strong>Advanced Options</strong>
                                    </button>
                                </h2>
                                <div id="advancedOptions" class="accordion-collapse collapse" data-bs-parent="#advancedAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <h6>Booklet Spine</h6>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" id="spine-side" name="spine-orient" checked onchange="refreshSpecs()">
                                                    <label class="form-check-label" for="spine-side">Side</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" id="spine-top" name="spine-orient" onchange="refreshSpecs()">
                                                    <label class="form-check-label" for="spine-top">Top</label>
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="flip-bc" onchange="refreshSpecs()">
                                                    <label class="form-check-label" for="flip-bc">
                                                        <small>Flip Back Cover (for Top-Fold Zines)</small>
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <h6>Paper Size</h6>
                                                <div class="row g-2 mb-2">
                                                    <div class="col">
                                                        <label for="rt-width" class="form-label" id="rt-width-label">Width</label>
                                                        <input type="number" class="form-control form-control-sm" id="rt-width" min="0.25" max="1100" value="8.5" onchange="refreshSpecs()">
                                                    </div>
                                                    <div class="col">
                                                        <label for="rt-height" class="form-label" id="rt-height-label">Height</label>
                                                        <input type="number" class="form-control form-control-sm" id="rt-height" min="0.25" max="1100" value="11" onchange="refreshSpecs()">
                                                    </div>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" id="page-inches" name="page-unit" checked onchange="refreshSpecs()">
                                                    <label class="form-check-label" for="page-inches">Inches</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" id="page-mm" name="page-unit" onchange="refreshSpecs()">
                                                    <label class="form-check-label" for="page-mm">Millimeters</label>
                                                </div>
                                                <div class="mt-2">
                                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="setPageUSLetter()">US Letter</button>
                                                    <button class="btn btn-sm btn-outline-secondary" onclick="setPageA4()">A4</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Print -->
            <div class="preview-section" id="step3-section">
                <div class="card step-card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="step-number">3</span>
                            <h3 class="mb-0">Print Your Zine</h3>
                        </div>
                        <p class="text-muted mb-3">Preview your zine layout below, then print or save as PDF</p>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-primary btn-lg" onclick="window.print()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="display: inline-block; vertical-align: middle;">
                                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                    <rect x="6" y="14" width="12" height="8"></rect>
                                </svg>
                                Print Zine
                            </button>
                            <a href="#" id="folding-ins-link" class="btn btn-outline-primary btn-lg">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="display: inline-block; vertical-align: middle;">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                Folding Instructions
                            </a>
                        </div>

                        <div class="alert alert-info">
                            <strong>üí° Printing Tips:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Choose "Save as PDF" or "Print to File" to save the zine without printing</li>
                                <li>Ensure your printer settings match the paper size selected above</li>
                                <li>For duplex printing, enable "Print on both sides" in your printer settings</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Zine Preview/Output -->
        <div class="zine-preview-container" id="zine" style="display:none">
        </div>
    </div>

    <script src="./vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
    var eighthSize = false; // whether the zine is an eighth size mini (false=either quarter or half depending on halfSize bit)
    var halfSize = false; // whether the zine is a half-size mini (false=either eighth or quarter, depending on eighthSize bit)
    var doubleSided = true; // whether we are printing double-sided
    var zinePortrait = true; // whether the zine is portrait orientation (false=landscape)
    var spineSide = true; // whether the spine is on the side of the zine (false=top spine)
    
    var flipBackCover = true; // whether to flip the back cover on top fold zines (false = cover is right-side up from outside; true = cover right side up when viewed as last page)
    
    var pagePortrait = false; // whether the printed page is portrait orientation (calculated based on above values)

    var aspectWidth = 11;
    var aspectHeight = 8.5;
    var divHoriz = 4; // number of horizontal pages per sheet
    var divVert = 2; // number of vertical pages per sheet
    var pagerat = 5.5/4.25;
    var sheetWidth = 1100;
    var sheetHeight = 850;
    var pageWidth = 275;
    var pageHeight = 425;
    var pageCount = 0;
    
    var specsString = "q2ps";
    
    var pgunit = "in";
    
    // UI State Management
    function updatePageCountWarning() {
        var pgmult = 0;
        
        if(eighthSize) {
            pgmult = doubleSided ? 16 : 8;
        } else if(halfSize) {
            pgmult = 4;
        } else { // quarter size
            pgmult = doubleSided ? 8 : 4;
        }
        
        var warningEl = document.getElementById("page-count-warning");
        var labelEl = document.getElementById("lbl-pc-mult");
        
        if (pageCount > 0 && pageCount % pgmult !== 0) {
            warningEl.style.display = "block";
            labelEl.innerHTML = "Your PDF has " + pageCount + " pages. To avoid blank pages, the page count should be a multiple of " + pgmult + ". " + (pgmult - (pageCount % pgmult)) + " blank page(s) will be added.";
        } else if (pageCount > 0) {
            warningEl.style.display = "block";
            labelEl.innerHTML = "Your PDF has " + pageCount + " pages, which is perfect for this format!";
            warningEl.classList.remove('alert-custom');
            warningEl.classList.add('alert-success');
        } else {
            warningEl.style.display = "none";
        }
    }
    
    function toggleAdvancedOptions() {
        if(document.getElementById("show-more").checked) {
            document.getElementById("advanced-options-a").style.display = "flex";
            document.getElementById("advanced-options-b").style.display = "flex";
        } else {
            document.getElementById("advanced-options-a").style.display = "none";
            document.getElementById("advanced-options-b").style.display = "none";
        }
    }
    
    function selectEighthSize() {
        document.getElementById("dx-single").checked = true;
        document.getElementById("ori-portrait").checked = true;
        document.getElementById("spine-side").checked = true;
        refreshSpecs();
    }
    
    function selectQuarterSize() {
        document.getElementById("dx-double").checked = true;
        document.getElementById("ori-portrait").checked = true;
        document.getElementById("spine-side").checked = true;
        refreshSpecs();
    }
    
    function selectHalfSize() {
        document.getElementById("dx-double").checked = true;
        document.getElementById("spine-side").checked = document.getElementById("ori-portrait").checked;
        refreshSpecs();
    }
    
    function setPageUSLetter() {
        document.getElementById("page-inches").checked = true;
        document.getElementById("rt-width").value = "8.5";
        document.getElementById("rt-height").value = "11";
        refreshSpecs();
    }
    
    function setPageA4() {
        document.getElementById("page-mm").checked = true;
        document.getElementById("rt-width").value = "210";
        document.getElementById("rt-height").value = "297";
        refreshSpecs();
    }
    
    // refreshes all parameters
    function refreshSpecs() {
        // poll main layout options
        eighthSize = document.getElementById("zs-mini").checked;
        halfSize = document.getElementById("zs-half").checked;
        doubleSided = document.getElementById("dx-double").checked;
        zinePortrait = document.getElementById("ori-portrait").checked;
        spineSide = document.getElementById("spine-side").checked;
        flipBackCover = document.getElementById("flip-bc").checked;
        
        specsString = "";
        if(eighthSize) {
            specsString = specsString + "e";
        } else if(halfSize) {
            specsString = specsString + "h";
        } else {
            specsString = specsString + "q";
        }
        
        if(doubleSided) {
            specsString = specsString + "2";
        } else {
            specsString = specsString + "1";
        }
        
        if(zinePortrait) {
            specsString = specsString + "p";
        } else {
            specsString = specsString + "l";
        }
        
        if(spineSide) {
            specsString = specsString + "s";
        } else {
            specsString = specsString + "t";
        }
        
        // Update folding instructions link
        document.getElementById("folding-ins-link").href = "folding.html?" + specsString;
        
        updatePageCountWarning();
        
        if(eighthSize) {
            if(doubleSided) {
                pgmult = 16;
            } else {
                pgmult = 8;
            }
        } else if(halfSize) {
            pgmult = 4;
        } else { // quarter size
            if(doubleSided) {
                pgmult = 8;
            } else {
                pgmult = 4;
            }
        }
         
        
        updatePageCountWarning();
        
        if (pageCount > 0) {
            document.getElementById("lbl-pc-mult").innerHTML = "To avoid blank pages at the end, the page count should be a multiple of " + pgmult + ".";
        }
        
        // calculate paper orientation based on above options
        pagePortrait = ((eighthSize || halfSize) && !zinePortrait) || (!(eighthSize || halfSize) && zinePortrait);
        
        // update aspect ratio labels & poll aspect ratio values
        // this is based on the paper orientation
        if(pagePortrait) {
            document.getElementById("rt-width-label").innerHTML = "Width";
            document.getElementById("rt-height-label").innerHTML = "Height";
            
            aspectWidth = document.getElementById("rt-width").value;
            aspectHeight = document.getElementById("rt-height").value;
        } else {
            document.getElementById("rt-width-label").innerHTML = "Height";
            document.getElementById("rt-height-label").innerHTML = "Width";
            
            aspectWidth = document.getElementById("rt-height").value;
            aspectHeight = document.getElementById("rt-width").value;
        }
        
        // calculate the zine page aspect ratio
        if(eighthSize) {
            if(zinePortrait) {
                divHoriz = 4;
                divVert = 2;
            } else {
                divVert = 4;
                divHoriz = 2;
            }
        } else {
            if(halfSize) {
                if(zinePortrait) {
                    divVert = 1;
                    divHoriz = 2;
                } else {
                    divHoriz = 1;
                    divVert = 2;
                }
            } else { // quarter size
                divVert = 2;
                divHoriz = 2;
            }
        }
        
        pagerat = (aspectWidth / divHoriz) / (aspectHeight / divVert);
    
        // update the CSS dimensions
        var scl = aspectWidth;
        if(scl == 0) {
            scl = 1;
        }
        while(scl < 1000) {
            scl *= 2;
        }
        var scl = scl / aspectWidth; // frame width is 574; this is 550 x2 (will be scaled by 0.5 in CSS)
        scl = Math.floor(scl,1);
        sheetWidth = scl*aspectWidth;
        sheetHeight = scl*aspectHeight;
        
        
        pgunit = "in";
        
        if(document.getElementById("page-mm").checked) {
            pgunit = "mm";
        }
        
        pageWidth = Math.floor(sheetWidth / divHoriz);
        pageHeight = Math.floor(sheetHeight / divVert);
        
        
        var rt = document.querySelector(':root');
        rt.style.setProperty('--sheet-width', sheetWidth + "px");
        rt.style.setProperty('--sheet-height', sheetHeight + "px");
        rt.style.setProperty('--page-width', pageWidth + "px");
        rt.style.setProperty('--page-height', pageHeight + "px");
        rt.style.setProperty('--sheet-scale', (550 / sheetWidth));
        
        selectFile(); // refresh the PDF if one has already been selected
    }
    
    function selectFile() {
        if(document.getElementById("selector").files.length > 0) {
            var fl = document.getElementById("selector").files[0];
            
            // Update UI to show file is loaded
            document.getElementById("file-info").style.display = "block";
            document.getElementById("file-name").textContent = fl.name;
            
            // Update file label
            document.getElementById("file-label-text").innerHTML = '<strong>File selected:</strong> ' + fl.name + '<br><small class="text-muted">Click to choose a different file</small>';
            
            document.getElementById("zine").style.display = "block";
            
            var nms = fl.name.split(".");
            if(nms.length > 1) {
                document.title = nms[0] + "-Printable." + nms[1];
            } else {
                document.title = fl.name + "-Printable.pdf";
            }
            var url = URL.createObjectURL(fl);
            
            const loadingTask = pdfjsLib.getDocument(url);
            (async () => {
                const pdf = await loadingTask.promise;
                
                var actualPageCount = pdf.numPages;
                pageCount = actualPageCount;
                
                // Update page count display
                document.getElementById("page-count").textContent = pageCount;
                
                updatePageCountWarning();
                arrangeZineSheets();
                //
                // Fetch the first page
                //
                for(var i = 1; i<actualPageCount+1; i++) {
                    const page = await pdf.getPage(i);
                    var viewport = page.getViewport({ scale: 1 });
                    var scale;
                    console.log("VPW: " + viewport.width + " || VPH: " + viewport.height + " || pagrat: " + pagerat + " || pageWidth: " + pageWidth + " || pageHeight: " + pageHeight);
                    if(viewport.width / viewport.height >= pagerat) {
                        scale = pageWidth / viewport.width;
                    } else {
                        scale = pageHeight / viewport.height;
                    }
                    //const scale = 72 / 4 * 11 / viewport.width;
                    viewport = page.getViewport({ scale: scale });
                    
                    const outputScale = 3;

                    //
                    // Prepare canvas using PDF page dimensions
                    //
                    const canvas = document.getElementById("p" + (i-1));
                    const context = canvas.getContext("2d");

                    canvas.width = Math.floor(viewport.width * outputScale);
                    canvas.height = Math.floor(viewport.height * outputScale);
                    canvas.style.width = Math.floor(viewport.width) + "px";
                    canvas.style.height = Math.floor(viewport.height) + "px";

                    const transform = outputScale !== 1
                      ? [outputScale, 0, 0, outputScale, 0, 0] 
                      : null;

                    //
                    // Render PDF page into canvas context
                    //
                    const renderContext = {
                      canvasContext: context,
                      transform,
                      viewport,
                    };
                    page.render(renderContext);
                }
          })();
        }
    }
    
    function arrangeZineSheets() {
        // clear the existing zine contents
        var zineContainer = document.getElementById("zine");
        zineContainer.innerHTML = "";
        var sheetsHTML = "";
        // compile the grid array
        var gridType = "";
        var rt = " rotate";
        
        if(eighthSize) {
            // orientation determines gridType, for both duplex & single (I think--not 100% on single)
            if(zinePortrait) {
                gridType = "eig-por";
            } else {
                gridType = "eig-lnd";
            }
            
            if(doubleSided) {  // EIGHTH DOUBLE
                if(pageCount % 16 != 0) { // round up to nearest 2 sides
                    pageCount += 16-(pageCount%16)
                }
                
                if(zinePortrait) {
                    setPageOrientation(false);
                    
                    if(spineSide) {  // eight duplex portrait side
                        for(let i = 0; i < pageCount / 16; i++) {
                            var s = 8 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-7) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+7) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2 + 1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else {  // eight duplex portrait top
                        for(let i = 0; i < pageCount / 16; i++) {
                            var s = 8 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-7) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (s+4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+7) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2 + 1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (s+6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                } else {
                    setPageOrientation(true);
                    
                    if(spineSide) { // eight duplex landscape side
                        for(let i = 0; i < pageCount / 16; i++) {
                            var s = 8 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+7) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (e-4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-7) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2 + 1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt +"\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (s+5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else {  // eight duplex landscape top
                        for(let i = 0; i < pageCount / 16; i++) {
                            var s = 8 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+7) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-7) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt +"\"><canvas class=\"zine-canvas\" id=\"p" + (s+4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-4) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2 + 1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-5) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-6) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                }
            } else { // standard 8-page mini algo
                if(pageCount % 8 != 0) { // round up to nearest 2 sides
                    pageCount += 8-(pageCount%8)
                }
                
                if(zinePortrait) { // eight single portrait
                    setPageOrientation(false);
                    
                    if(spineSide) {
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 4 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else {
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 4 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i) + "\">";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                } else { // eight single landscape
                    setPageOrientation(true);
                    
                    if(spineSide) {
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 4 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else {
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 4 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tml" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+3) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl\"><canvas class=\"zine-canvas\" id=\"p" + (e-2) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bml" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page bmr\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                }    
            }        
        } else if(halfSize) {    // HALF SIZE (PORTRAIT & LANDSCAPE ONLY)
            if(pageCount % 4 != 0) {
                pageCount += 4-(pageCount%4);
            }
            
            if(zinePortrait) {
                gridType = "half-por";
                
                for(let i = 0; i < pageCount / 4; i++) {
                    var s = 2*i;
                    var e = pageCount - s - 1;
                    
                    sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                    sheetsHTML = sheetsHTML + "</div>";
                    
                    sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2+1) + "\">";
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                    sheetsHTML = sheetsHTML + "</div>";                 
                }
            } else {
                gridType = "half-lnd";
                
                for(let i = 0; i < pageCount / 4; i++) {
                    var s = 2*i;
                    var e = pageCount - s - 1;
                    
                    sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i) + "\">";
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + s + "\"></canvas></section>";
                    if(!flipBackCover && i == 0) {
                        sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + e + "\"></canvas></section>";
                    } else {
                        sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + e + "\"></canvas></section>";
                    }
                    sheetsHTML = sheetsHTML + "</div>";
                    
                    sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i) + "\">";
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + s+1 + "\"></canvas></section>"; 
                    sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + e-1 + "\"></canvas></section>";
                    sheetsHTML = sheetsHTML + "</div>";
                }
            }
        } else { // quarter size
            /*if(spineSide) {
                gridType = "qtr-side"; // grid for quarter-sized side fold
            } else {
                gridType = "qtr-top"; // grid for quarter-sized top fold
            }*/
            gridType = "qtr-side"; // just doing the default grid cause we'll rearrange in each block now
            
            if(doubleSided) { // QUARTER DOUBLE
                if(pageCount % 8 != 0) { // round up to nearest 2 sides
                    pageCount += 8-(pageCount % 8);
                }
                
                if(zinePortrait) {
                    setPageOrientation(true);
                    if(spineSide) { // quarter duplex portrait side
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            var m = s + (pageCount / 4); // technically = s + 2(pageCount / 8), but I have reduced; 2 is pages per corner, pageCount/8 is number of sheets
                            var n = e - (pageCount / 4);
                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (n) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (m) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2+1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (m+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (n-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else { // quarter duplex portrait top
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            var m = s + (pageCount / 4); // technically = s + 2(pageCount / 8), but I have reduced; 2 is pages per corner, pageCount/8 is number of sheets
                            var n = e - (pageCount / 4);
                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (n) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (m) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2+1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (n-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (m+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                } else {
                    setPageOrientation(false);
                    if(spineSide) { // quarter duplex landscape side
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            var m = s + (pageCount / 4); // technically = s + 2(pageCount / 8), but I have reduced; 2 is pages per corner, pageCount/8 is number of sheets
                            var n = e - (pageCount / 4);
                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (n) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (m) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2+1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (m+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + "\"><canvas class=\"zine-canvas\" id=\"p" + (n-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else { // quarter duplex landscape top
                        for(let i = 0; i < pageCount / 8; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            var m = s + (pageCount / 4); // technically = s + 2(pageCount / 8), but I have reduced; 2 is pages per corner, pageCount/8 is number of sheets
                            var n = e - (pageCount / 4);
                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (n) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (m) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                                        
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet " + gridType + "\" id=\"s" + (i*2+1) + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (n-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (m+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                }
            } else {    // QUARTER SINGLE
                if(pageCount % 4 != 0) { // round up to nearest 4 multiple
                    pageCount += 4-(pageCount % 4);
                }
                
                if(zinePortrait) {
                    setPageOrientation(true);
                    if(spineSide) { // quarter single portrait side
                        for(let i = 0; i < pageCount / 4; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet\" id=\"s" + i + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";    
                            sheetsHTML = sheetsHTML + "</div>";
                        }       
                    } else { // quarter single portrait top
                        for(let i = 0; i < pageCount / 4; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet\" id=\"s" + i + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";    
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                } else {
                    setPageOrientation(false);
                    if(spineSide) { // quarter single landscape side
                        for(let i = 0; i < pageCount / 4; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet\" id=\"s" + i + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";    
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    } else { // quarter single landscape top
                        for(let i = 0; i < pageCount / 4; i++) {
                            var s = 2 * i;
                            var e = pageCount - s - 1;
                            
                            sheetsHTML = sheetsHTML + "<div class=\"zine-sheet\" id=\"s" + i + "\">";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page tl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e-1) + "\"></canvas></section>";
                            if(!flipBackCover && i == 0) {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            } else {
                                sheetsHTML = sheetsHTML + "<section class=\"zine-page tr" + "\"><canvas class=\"zine-canvas\" id=\"p" + (e) + "\"></canvas></section>";
                            }
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page bl" + rt + "\"><canvas class=\"zine-canvas\" id=\"p" + (s+1) + "\"></canvas></section>";
                            sheetsHTML = sheetsHTML + "<section class=\"zine-page br" + "\"><canvas class=\"zine-canvas\" id=\"p" + (s) + "\"></canvas></section>";    
                            sheetsHTML = sheetsHTML + "</div>";
                        }
                    }
                }
            }
        }
        
        zineContainer.innerHTML = sheetsHTML;
    }
    
    function setPageOrientation(prt) {
        //document.getElementById("page-orient-style").innerHTML = "@media print { @page { size: " + aspectWidth + pgunit + " " + aspectHeight + pgunit + "; } }";
        //document.getElementById("page-orient-style").innerHTML = "@media print { @page { size: " + sheetWidth + "px " + sheetHeight + "px; } }";
        
        if(prt) {
            document.getElementById("page-orient-style").innerHTML = "@media print { @page { size: portrait; } }";
        } else {
            document.getElementById("page-orient-style").innerHTML = "@media print { @page { size: landscape; } }";
        }
    }
    
    document.getElementById("selector").addEventListener("change", refreshSpecs, false);
    
    // Drag and drop functionality
    const fileLabel = document.getElementById('file-label');
    const fileInput = document.getElementById('selector');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileLabel.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        fileLabel.addEventListener(eventName, () => {
            fileLabel.style.borderColor = '#764ba2';
            fileLabel.style.backgroundColor = '#e8ebff';
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        fileLabel.addEventListener(eventName, () => {
            fileLabel.style.borderColor = '#667eea';
            fileLabel.style.backgroundColor = '#f8f9ff';
        }, false);
    });
    
    fileLabel.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            refreshSpecs();
        }
    }, false);
    
    refreshSpecs();
</script>
</body>
</html>
